import { Subject, BehaviorSubject, timer, of, combineLatest, Subscription, EMPTY } from 'rxjs';
import { tap, delay, debounce, switchMap, takeUntil, finalize, filter } from 'rxjs/operators';
export class NgProgressRef {
    // Get current progress state
    get snapshot() {
        return this._state.value;
    }
    // Check if progress has started
    get isStarted() {
        return this.snapshot.active;
    }
    constructor(customConfig, _onDestroyCallback) {
        this._onDestroyCallback = _onDestroyCallback;
        // Progress start source event (used to cancel finalizing delays)
        this._started = new Subject();
        // Progress start event: stream that emits only when it hasn't already started
        this.started = this._started.pipe(filter(() => !this.isStarted));
        // Progress ended source event
        this._completed = new Subject();
        // Progress start event: stream that emits only when it has already started
        this.completed = this._completed.pipe(filter(() => this.isStarted));
        // Stream that increments and updates the progress state
        this._trickling = new Subject();
        // Stream that combines "_trickling" and "config" streams
        this._worker = Subscription.EMPTY;
        this._state = new BehaviorSubject({ active: false, value: 0 });
        this._config = new BehaviorSubject(customConfig);
        this.state = this._state.asObservable();
        this.config = this._config.asObservable();
        this._worker = combineLatest([this._trickling, this._config]).pipe(debounce(([start, config]) => timer(start ? config.debounceTime : 0)), switchMap(([start, config]) => start ? this.onTrickling(config) : this.onComplete(config))).subscribe();
    }
    /**
     * Start the progress
     */
    start() {
        this._started.next();
        this._trickling.next(true);
    }
    /**
     * Complete the progress
     */
    complete() {
        this._trickling.next(false);
    }
    /**
     * Increment the progress
     */
    inc(amount) {
        const n = this.snapshot.value;
        if (!this.isStarted) {
            this.start();
        }
        else {
            if (typeof amount !== 'number') {
                amount = this._config.value.trickleFunc(n);
            }
            this.set(n + amount);
        }
    }
    /**
     * Set the progress
     */
    set(n) {
        this.setState({ value: this.clamp(n), active: true });
    }
    /**
     * Set config
     */
    setConfig(config) {
        this._config.next({ ...this._config.value, ...config });
    }
    /**
     * Destroy progress reference
     */
    destroy() {
        this._worker.unsubscribe();
        this._trickling.complete();
        this._state.complete();
        this._config.complete();
        this._started.complete();
        this._completed.complete();
        this._onDestroyCallback();
    }
    /**
     * Set progress state
     */
    setState(state) {
        this._state.next({ ...this.snapshot, ...state });
    }
    /**
     * Clamps a value to be between min and max
     */
    clamp(n) {
        return Math.max(this._config.value.min, Math.min(this._config.value.max, n));
    }
    /**
     * Keeps incrementing the progress
     */
    onTrickling(config) {
        if (!this.isStarted) {
            this.set(this._config.value.min);
        }
        return timer(0, config.trickleSpeed).pipe(tap(() => this.inc()));
    }
    /**
     * Completes then resets the progress
     */
    onComplete(config) {
        this._completed.next();
        return !this.isStarted ? EMPTY : of({}).pipe(
        // Complete the progress
        tap(() => this.setState({ value: 100 })), 
        // Deactivate the progress after a tiny delay
        delay(config.speed * 1.7), tap(() => this.setState({ active: false })), 
        // Use a tiny delay before resetting
        delay(config.speed), 
        // Force the progress to reset even it got cancelled
        finalize(() => this.setState({ value: 0 })), 
        // Cancel any of the finalizing delays if the progress has started again
        takeUntil(this._started));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcHJvZ3Jlc3MtcmVmLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXByb2dyZXNzYmFyL3NyYy9saWIvbmctcHJvZ3Jlc3MtcmVmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxPQUFPLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0csT0FBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzlGLE1BQU0sT0FBTyxhQUFhO0lBMEJ4Qiw2QkFBNkI7SUFDN0IsSUFBWSxRQUFRO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDM0IsQ0FBQztJQUVELGdDQUFnQztJQUNoQyxJQUFJLFNBQVM7UUFDWCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO0lBQzlCLENBQUM7SUFFRCxZQUFZLFlBQTRCLEVBQVUsa0JBQThCO1FBQTlCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBWTtRQTFCaEYsaUVBQWlFO1FBQ2hELGFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBUSxDQUFDO1FBQ2hELDhFQUE4RTtRQUNyRSxZQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFFckUsOEJBQThCO1FBQ2IsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7UUFDbEQsMkVBQTJFO1FBQ2xFLGNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENB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Q0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUk7UUFDMUMsd0JBQXdCO1FBQ3hCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFFeEMsNkNBQTZDO1FBQzdDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxFQUN6QixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRTNDLG9DQUFvQztRQUNwQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNuQixvREFBb0Q7UUFDcEQsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMzQyx3RUFBd0U7UUFDeEUsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FDekIsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgdGltZXIsIG9mLCBjb21iaW5lTGF0ZXN0LCBTdWJzY3JpcHRpb24sIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCwgZGVsYXksIGRlYm91bmNlLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgZmluYWxpemUsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTmdQcm9ncmVzc1N0YXRlLCBOZ1Byb2dyZXNzQ29uZmlnLCBQcm9ncmVzc0NvbmZpZywgUHJvZ3Jlc3NTdGF0ZSB9IGZyb20gJy4vbmctcHJvZ3Jlc3MuaW50ZXJmYWNlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBOZ1Byb2dyZXNzUmVmIHtcclxuXHJcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBwcm9ncmVzcyBzdGF0ZSBpcyBjaGFuZ2VkXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhdGU6IEJlaGF2aW9yU3ViamVjdDxQcm9ncmVzc1N0YXRlPjtcclxuICBzdGF0ZTogT2JzZXJ2YWJsZTxQcm9ncmVzc1N0YXRlPjtcclxuXHJcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBjb25maWcgaXMgY2hhbmdlZFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX2NvbmZpZzogQmVoYXZpb3JTdWJqZWN0PFByb2dyZXNzQ29uZmlnPjtcclxuICBjb25maWc6IE9ic2VydmFibGU8UHJvZ3Jlc3NDb25maWc+O1xyXG5cclxuICAvLyBQcm9ncmVzcyBzdGFydCBzb3VyY2UgZXZlbnQgKHVzZWQgdG8gY2FuY2VsIGZpbmFsaXppbmcgZGVsYXlzKVxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3N0YXJ0ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG4gIC8vIFByb2dyZXNzIHN0YXJ0IGV2ZW50OiBzdHJlYW0gdGhhdCBlbWl0cyBvbmx5IHdoZW4gaXQgaGFzbid0IGFscmVhZHkgc3RhcnRlZFxyXG4gIHJlYWRvbmx5IHN0YXJ0ZWQgPSB0aGlzLl9zdGFydGVkLnBpcGUoZmlsdGVyKCgpID0+ICF0aGlzLmlzU3RhcnRlZCkpO1xyXG5cclxuICAvLyBQcm9ncmVzcyBlbmRlZCBzb3VyY2UgZXZlbnRcclxuICBwcml2YXRlIHJlYWRvbmx5IF9jb21wbGV0ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG4gIC8vIFByb2dyZXNzIHN0YXJ0IGV2ZW50OiBzdHJlYW0gdGhhdCBlbWl0cyBvbmx5IHdoZW4gaXQgaGFzIGFscmVhZHkgc3RhcnRlZFxyXG4gIHJlYWRvbmx5IGNvbXBsZXRlZCA9IHRoaXMuX2NvbXBsZXRlZC5waXBlKGZpbHRlcigoKSA9PiB0aGlzLmlzU3RhcnRlZCkpO1xyXG5cclxuICAvLyBTdHJlYW0gdGhhdCBpbmNyZW1lbnRzIGFuZCB1cGRhdGVzIHRoZSBwcm9ncmVzcyBzdGF0ZVxyXG4gIHByaXZhdGUgcmVhZG9ubHkgX3RyaWNrbGluZyA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGNvbWJpbmVzIFwiX3RyaWNrbGluZ1wiIGFuZCBcImNvbmZpZ1wiIHN0cmVhbXNcclxuICBwcml2YXRlIHJlYWRvbmx5IF93b3JrZXIgPSBTdWJzY3JpcHRpb24uRU1QVFk7XHJcblxyXG4gIC8vIEdldCBjdXJyZW50IHByb2dyZXNzIHN0YXRlXHJcbiAgcHJpdmF0ZSBnZXQgc25hcHNob3QoKTogUHJvZ3Jlc3NTdGF0ZSB7XHJcbiAgICByZXR1cm4gdGhpcy5fc3RhdGUudmFsdWU7XHJcbiAgfVxyXG5cclxuICAvLyBDaGVjayBpZiBwcm9ncmVzcyBoYXMgc3RhcnRlZFxyXG4gIGdldCBpc1N0YXJ0ZWQoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5zbmFwc2hvdC5hY3RpdmU7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihjdXN0b21Db25maWc6IFByb2dyZXNzQ29uZmlnLCBwcml2YXRlIF9vbkRlc3Ryb3lDYWxsYmFjazogKCkgPT4gdm9pZCkge1xyXG4gICAgdGhpcy5fc3RhdGUgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFByb2dyZXNzU3RhdGU+KHsgYWN0aXZlOiBmYWxzZSwgdmFsdWU6IDAgfSk7XHJcbiAgICB0aGlzLl9jb25maWcgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFByb2dyZXNzQ29uZmlnPihjdXN0b21Db25maWcpO1xyXG4gICAgdGhpcy5zdGF0ZSA9IHRoaXMuX3N0YXRlLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgdGhpcy5jb25maWcgPSB0aGlzLl9jb25maWcuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gICAgdGhpcy5fd29ya2VyID0gY29tYmluZUxhdGVzdChbdGhpcy5fdHJpY2tsaW5nLCB0aGlzLl9jb25maWddKS5waXBlKFxyXG4gICAgICBkZWJvdW5jZSgoW3N0YXJ0LCBjb25maWddOiBbYm9vbGVhbiwgUHJvZ3Jlc3NDb25maWddKSA9PiB0aW1lcihzdGFydCA/IGNvbmZpZy5kZWJvdW5jZVRpbWUgOiAwKSksXHJcbiAgICAgIHN3aXRjaE1hcCgoW3N0YXJ0LCBjb25maWddOiBbYm9vbGVhbiwgUHJvZ3Jlc3NDb25maWddKSA9PiBzdGFydCA/IHRoaXMub25Ucmlja2xpbmcoY29uZmlnKSA6IHRoaXMub25Db21wbGV0ZShjb25maWcpKVxyXG4gICAgKS5zdWJzY3JpYmUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0YXJ0IHRoZSBwcm9ncmVzc1xyXG4gICAqL1xyXG4gIHN0YXJ0KCkge1xyXG4gICAgdGhpcy5fc3RhcnRlZC5uZXh0KCk7XHJcbiAgICB0aGlzLl90cmlja2xpbmcubmV4dCh0cnVlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbXBsZXRlIHRoZSBwcm9ncmVzc1xyXG4gICAqL1xyXG4gIGNvbXBsZXRlKCkge1xyXG4gICAgdGhpcy5fdHJpY2tsaW5nLm5leHQoZmFsc2UpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSW5jcmVtZW50IHRoZSBwcm9ncmVzc1xyXG4gICAqL1xyXG4gIGluYyhhbW91bnQ/OiBudW1iZXIpIHtcclxuICAgIGNvbnN0IG4gPSB0aGlzLnNuYXBzaG90LnZhbHVlO1xyXG4gICAgaWYgKCF0aGlzLmlzU3RhcnRlZCkge1xyXG4gICAgICB0aGlzLnN0YXJ0KCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAodHlwZW9mIGFtb3VudCAhPT0gJ251bWJlcicpIHtcclxuICAgICAgICBhbW91bnQgPSB0aGlzLl9jb25maWcudmFsdWUudHJpY2tsZUZ1bmMobik7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zZXQobiArIGFtb3VudCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXQgdGhlIHByb2dyZXNzXHJcbiAgICovXHJcbiAgc2V0KG46IG51bWJlcikge1xyXG4gICAgdGhpcy5zZXRTdGF0ZSh7IHZhbHVlOiB0aGlzLmNsYW1wKG4pLCBhY3RpdmU6IHRydWUgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXQgY29uZmlnXHJcbiAgICovXHJcbiAgc2V0Q29uZmlnKGNvbmZpZzogTmdQcm9ncmVzc0NvbmZpZykge1xyXG4gICAgdGhpcy5fY29uZmlnLm5leHQoeyAuLi50aGlzLl9jb25maWcudmFsdWUsIC4uLmNvbmZpZyB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIERlc3Ryb3kgcHJvZ3Jlc3MgcmVmZXJlbmNlXHJcbiAgICovXHJcbiAgZGVzdHJveSgpIHtcclxuICAgIHRoaXMuX3dvcmtlci51bnN1YnNjcmliZSgpO1xyXG4gICAgdGhpcy5fdHJpY2tsaW5nLmNvbXBsZXRlKCk7XHJcbiAgICB0aGlzLl9zdGF0ZS5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5fY29uZmlnLmNvbXBsZXRlKCk7XHJcbiAgICB0aGlzLl9zdGFydGVkLmNvbXBsZXRlKCk7XHJcbiAgICB0aGlzLl9jb21wbGV0ZWQuY29tcGxldGUoKTtcclxuICAgIHRoaXMuX29uRGVzdHJveUNhbGxiYWNrKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXQgcHJvZ3Jlc3Mgc3RhdGVcclxuICAgKi9cclxuICBwcml2YXRlIHNldFN0YXRlKHN0YXRlOiBOZ1Byb2dyZXNzU3RhdGUpIHtcclxuICAgIHRoaXMuX3N0YXRlLm5leHQoeyAuLi50aGlzLnNuYXBzaG90LCAuLi5zdGF0ZSB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENsYW1wcyBhIHZhbHVlIHRvIGJlIGJldHdlZW4gbWluIGFuZCBtYXhcclxuICAgKi9cclxuICBwcml2YXRlIGNsYW1wKG46IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gTWF0aC5tYXgodGhpcy5fY29uZmlnLnZhbHVlLm1pbiwgTWF0aC5taW4odGhpcy5fY29uZmlnLnZhbHVlLm1heCwgbikpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogS2VlcHMgaW5jcmVtZW50aW5nIHRoZSBwcm9ncmVzc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgb25Ucmlja2xpbmcoY29uZmlnOiBQcm9ncmVzc0NvbmZpZyk6IE9ic2VydmFibGU8bnVtYmVyPiB7XHJcbiAgICBpZiAoIXRoaXMuaXNTdGFydGVkKSB7XHJcbiAgICAgIHRoaXMuc2V0KHRoaXMuX2NvbmZpZy52YWx1ZS5taW4pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRpbWVyKDAsIGNvbmZpZy50cmlja2xlU3BlZWQpLnBpcGUodGFwKCgpID0+IHRoaXMuaW5jKCkpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbXBsZXRlcyB0aGVuIHJlc2V0cyB0aGUgcHJvZ3Jlc3NcclxuICAgKi9cclxuICBwcml2YXRlIG9uQ29tcGxldGUoY29uZmlnOiBQcm9ncmVzc0NvbmZpZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICB0aGlzLl9jb21wbGV0ZWQubmV4dCgpO1xyXG4gICAgcmV0dXJuICF0aGlzLmlzU3RhcnRlZCA/IEVNUFRZIDogb2Yoe30pLnBpcGUoXHJcbiAgICAgIC8vIENvbXBsZXRlIHRoZSBwcm9ncmVzc1xyXG4gICAgICB0YXAoKCkgPT4gdGhpcy5zZXRTdGF0ZSh7IHZhbHVlOiAxMDAgfSkpLFxyXG5cclxuICAgICAgLy8gRGVhY3RpdmF0ZSB0aGUgcHJvZ3Jlc3MgYWZ0ZXIgYSB0aW55IGRlbGF5XHJcbiAgICAgIGRlbGF5KGNvbmZpZy5zcGVlZCAqIDEuNyksXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNldFN0YXRlKHsgYWN0aXZlOiBmYWxzZSB9KSksXHJcblxyXG4gICAgICAvLyBVc2UgYSB0aW55IGRlbGF5IGJlZm9yZSByZXNldHRpbmdcclxuICAgICAgZGVsYXkoY29uZmlnLnNwZWVkKSxcclxuICAgICAgLy8gRm9yY2UgdGhlIHByb2dyZXNzIHRvIHJlc2V0IGV2ZW4gaXQgZ290IGNhbmNlbGxlZFxyXG4gICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLnNldFN0YXRlKHsgdmFsdWU6IDAgfSkpLFxyXG4gICAgICAvLyBDYW5jZWwgYW55IG9mIHRoZSBmaW5hbGl6aW5nIGRlbGF5cyBpZiB0aGUgcHJvZ3Jlc3MgaGFzIHN0YXJ0ZWQgYWdhaW5cclxuICAgICAgdGFrZVVudGlsKHRoaXMuX3N0YXJ0ZWQpXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=